{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{'/plugin/attendance_check/static/css/style.css' }}">
{% endblock head %}

{% block title %}
    {{ title }}
{% endblock title %}

{% block subtitle %}
{% endblock subtitle %}

{% block content %}

    <section class="calendar_section">
        <div id='attendance_list'>
            <div class='calendar_header'>
                <div class="calendar_header_first_row">
                    <div>
                        <span id='calendar_header_center_year'></span>년
                        <span id='calendar_header_center_month'></span>월
                    </div>
                    <div class="attendance_statue">
                        <div><i class="icon_attendance">O</i>출석 수:&nbsp
                            <span id='attendance_count' class="count_text"></span>일
                        </div>
                        <span class="sound_only" id="absent_count"></span>
<!--                        <div><i class="icon_absent">X</i>결석 수:&nbsp<span id='absent_count' class="count_text"></span>일-->
<!--                        </div>-->
                    </div>
                </div>
                
                <div class="calendar_header_button">
                    <div id='calendar_header_left'>
                        <button id='calendar_header_left_button'>이전 달</button>
                    </div>
                    <div id='calendar_header_right'>
                        <button id='calendar_header_right_button'> 다음 달</button>
                    </div>

                </div>
            </div>
            <div>
                <div id='calendar_body_week'>
                    <div class='calendar_body_week_day'>일</div>
                    <div class='calendar_body_week_day'>월</div>
                    <div class='calendar_body_week_day'>화</div>
                    <div class='calendar_body_week_day'>수</div>
                    <div class='calendar_body_week_day'>목</div>
                    <div class='calendar_body_week_day'>금</div>
                    <div class='calendar_body_week_day'>토</div>
                </div>
                <div id='calendar_body' data-attendance-id="{{ request.path_params.attendance_id }}">
                </div>
            </div>

        </div>
    </section>


    <button type="button" class="cmt_btn">
        <span class="total"><b>댓글</b> {{ comments|count }}</span>
        <span class="cmt_more"></span>
    </button>
    <!-- 댓글 시작 { -->
    <section id="bo_vc">
        <h2>댓글목록</h2>
        {% for comment in comments %}
        <article id="c_{{ comment.id }}">
            <div class="pf_img"><img src="/{{ get_member_image(comment.mb_id) }}" alt="profile_image"></div>
            <div class="cm_wrap">
                <header>
                    <h2>{{ comment.member[0].mb_nick }}님의  댓글</h2>
                        <span class="{% if comment.mb_id %}member{% else %}guest{% endif %}">
                            {{ comment.member[0].mb_nick }}
                        </span>
                    <span class="sound_only">작성일</span>
                    <span class="bo_vc_hdinfo">
                        <i class="fa fa-clock-o" aria-hidden="true"></i>
                        <time datetime="{{ comment.created_at|datetime_format }}">
                            {{ comment.created_at|datetime_format('%Y-%m-%d %H:%M') }}
                        </time>
                    </span>
                </header>
        
                <div class="cmt_comments">
                    <p>
                       {{ comment.comment }}
                    </p>
                </div>
<!--                <span id="edit_{{ comment.id }}" class="bo_vc_w"></span>&lt;!&ndash; 수정 &ndash;&gt;-->
<!--                <span id="reply_{{ comment.id }}" class="bo_vc_w"></span>&lt;!&ndash; 답변 &ndash;&gt;-->
                <textarea id="save_comment_{{ comment.id }}" style="display:none">{{ comment.save_content|safe }}</textarea>
            </div>
            {% if request.state.is_super_admin or comment.mb_id == request.login_member %}
            <div class="bo_vl_opt">
                <button type="button" class="btn_cm_opt btn_b01 btn">
                    <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                    <span class="sound_only">댓글 옵션</span>
                </button>
                
                <ul class="bo_vc_act" style="display: none;">
<!--                    <li><a href="javascript:;" onclick="comment_box('{{ comment.id }}', 'cu'); return false;">수정</a></li>-->
                    <li><a href="/attendance/{{comment.attendance_config_id}}/delete_comment/{{ comment.id }}" onclick="comment_delete(this.href); return false;">삭제</a></li>
                </ul>
            </div>
            {% endif %}
        </article>
        {% else %}
        <p id="bo_vc_empty">등록된 댓글이 없습니다.</p>
        {% endfor %}
    </section>
    <!-- } 댓글 끝 -->
    <!-- 댓글 쓰기 시작 { -->

    {% if request.state.login_member %}

    <aside id="bo_vc_w" class="bo_vc_w">
        
        <h2>댓글쓰기</h2>
            
        <form name="fviewcomment" id="fviewcomment"
              action="{{ url_for('save_adttendance_comment', attendance_id=request.path_params.attendance_id ) }}" 
              onsubmit="return fcomment_submit(this);" method="post" autocomplete="off">
            <input type="hidden" name="w" id="w" value="c">
            <input type="hidden" name="id" value="{{ request.query_params.id }}" id="comment_id">
            <input type="hidden" name="sca" value="{{ request.query_params.sca }}">
            <input type="hidden" name="sfl" value="{{ request.query_params.sfl }}">
            <input type="hidden" name="stx" value="{{ request.query_params.stx }}">
            <input type="hidden" name="spt" value="{{ request.query_params.spt }}">
            <input type="hidden" name="page" value="{{ request.query_params.page }}">
            <input type="hidden" name="token" value="">

            <span class="sound_only">내용</span>
            <textarea id="comment" name="comment" maxlength="1000" required="" class="required" 
                      onkeydown="" 
                      title="댓글 내용" placeholder="댓글내용을 입력해주세요"></textarea>
            <div class="bo_vc_w_wr">
                <div class="bo_vc_w_info">
                </div>
                <div class="btn_confirm">
                    <button type="submit" id="btn_submit" class="btn_submit">댓글등록</button>
                </div>
            </div>
        </form>
            <script>
            $(document).on("keyup change", "textarea#comment[maxlength]", function() {
                var str = $(this).val()
                var mx = parseInt($(this).attr("maxlength"))
                if (str.length > mx) {
                    $(this).val(str.substr(0, mx));
                    return false;
                }
            });
    
            // 글자수 제한
            var char_min = 1 // 최소
            var char_max = 1000; // 최대
            
            var save_before = '';
            
            function fcomment_submit(f)
            {
                f.comment.value = f.comment.value.trim();
                
                if (f.comment.value.length > char_max) {
                    alert("댓글은 " + char_max + "글자 이하로 입력해주세요.");
                    return false;
                }
                
                if (f.comment.value.length < char_min) {
                    alert("댓글은 " + char_min + "글자 이상 입력해주세요.");
                    return false;
                }
                
                if (!f.comment.value) {
                    alert("댓글을 입력하여 주십시오.");
                    return false;
                }
    
                f.token.value = generate_token();
                if (f.token.value == "") {
                    alert("토큰값이 없습니다.");
                    return false;
                }    
                return true;
                
            }
    
            function comment_box(comment_id, work)
            {
                var el_id,
                    form_el = 'fviewcomment',
                    respond = document.getElementById(form_el);
    
                // 댓글 아이디가 넘어오면 답변, 수정
                if (comment_id) {
                    if (work == 'cu') {
                        el_id = 'edit_' + comment_id;
                    }
                } else {
                    el_id = 'bo_vc_w';
                }
    
                if (save_before != el_id)
                {
                    if (save_before)
                    {
                        document.getElementById(save_before).style.display = 'none';
                    }
    
                    document.getElementById(el_id).style.display = '';
                    document.getElementById(el_id).appendChild(respond);
                    //입력값 초기화
                    document.getElementById('comment').value = '';
                    
                    // 댓글 수정
                    if (work == 'cu')
                    {
                        document.getElementById('comment').value = document.getElementById('save_comment_' + comment_id).value;
                        if (typeof char_count != 'undefined') {
                            get_string_length('comment', 'char_count');
                        }
                    }
    
                    document.getElementById('comment_id').value = comment_id;
                    document.getElementById('w').value = work;
    
                    if(save_before)
                        $("#captcha_reload").trigger("click");
    
                    save_before = el_id;
                }
            }
    
            function comment_delete(href) {
                if (confirm("이 댓글을 삭제하시겠습니까?")) {
                    token = generate_token();
                    location.href = href + "?token=" + token
                    return true;
                }
                return false;
            }
    
            comment_box('', 'c');
    
        </script>
    </aside>
    {% else %}
    <div>
        <p>출석체크를 하시려면 로그인을 해주세요.</p>
    </div>
    {% endif %}
    

    <!-- } 댓글 쓰기 끝 -->
    <script>
        $(function() {			    
            // 댓글 옵션창 열기
            $(".btn_cm_opt").on("click", function(){
                $(this).parent("div").children(".bo_vc_act").show();
            });
                
            // 댓글 옵션창 닫기
            $(document).mouseup(function (e){
                var container = $(".bo_vc_act");
                if( container.has(e.target).length === 0)
                container.hide();
            });
        });

        const today = new Date();
        let year = today.getFullYear();
        let month = today.getMonth() + 1;
        let today_date = today.getDate();
        let today_day = today.getDay();

        const calendar_config = {
            year: year,
            month: month,
            date: today_date,
            current_time: today,
            attendance_count: 0,
            absent_count: 0
        }

        /**
         * 출결 데이터 전역변수
         * @type {*[]}
         */
        let attendance_list = [];
        init();

        function init() {
            get_attendance_check_list(year, month);
            calendar_render(attendance_list);
            
            set_calendar_header();

            const next_month = document.querySelector('#calendar_header_right_button');
            const prev_month = document.querySelector('#calendar_header_left_button');

            next_month.addEventListener('click', show_next_month);
            prev_month.addEventListener('click', show_prev_month);
            add_event_calendar_body();
        }
        
        function add_event_calendar_body() {
            calendar_body_item = document.querySelectorAll('.calendar_body_item');
            calendar_body_item.forEach(function (item) {
                item.addEventListener('click', function (e) {
                    let calendar_date = ''
                    if (e.target.querySelector('.calendar_date') != null) {
                        calendar_date = e.target.querySelector('.calendar_date').innerText;
                    }
                    else if (e.target.classList.contains('calendar_date')){
                        calendar_date = e.target.innerText;
                    } else {
                        calendar_date_node = e.target.querySelector('.calendar_date')
                        if (calendar_date_node != null) {
                            calendar_date = calendar_date.innerText;
                        }
                    }
                
                    if (calendar_date == null || calendar_date == '' || calendar_date.innerText == '') {
                        return;
                    }
                    const date = calendar_date.innerText;
                    const attendance_date = new Date(calendar_config.year, calendar_config.month - 1, calendar_date);
                    if (new Date().toDateString() != attendance_date.toDateString()) {
                        alert('오늘 날짜만 출석체크가 가능합니다');
                        return;
                    }
                    if (isValidDate(attendance_date)) {
                        attendance_check(attendance_date);
                    }
                });
            });
        }
        
        function isValidDate(date) {
          return date instanceof Date && !isNaN(date);
        }

        /**
         * +1 -1 (이전, 이후 달 만설정)
         * @param modify_number
         * @returns {null}
         */
        function set_month(modify_number) {
            if (modify_number > 1 || modify_number < -1) {
                return;
            }

            const month = calendar_config.month
            calendar_config.month += modify_number;
            if (month + modify_number > 12) {
                calendar_config.year++;
                calendar_config.month = (month + modify_number) % 12
            }

            if (month + modify_number < 1) {
                calendar_config.year--;
                calendar_config.month = 12;
            }
        }

        function show_next_month() {
            // 다음년도 1월로 넘어가지 않게
            if((today.getFullYear() < calendar_config.year + 1) && (today.getMonth() + 1 < calendar_config.month + 1)) {
                return false;
            }
            set_month(1);
            set_calendar_header();
            calendar_render(attendance_list);
        }

        function show_prev_month() {
            set_month(-1);
            set_calendar_header();
            calendar_render(attendance_list);
        }

        function set_calendar_header() {
            const calendar_header_center_year = document.getElementById('calendar_header_center_year');
            const calendar_header_center_month = document.getElementById('calendar_header_center_month');
            calendar_header_center_year.innerText = calendar_config.year;
            calendar_header_center_month.innerText = calendar_config.month;
        }

        function get_attendance_check_list(year, month) {
            calendar_body = document.getElementById('calendar_body');
            attendance_id = calendar_body.getAttribute('data-attendance-id');  
            $.ajax({
                url: g5_url + 'attendance/ajax/'+ attendance_id +'/info',
                type: 'post',
                data: JSON.stringify({
                    mode: 'get_attendance_check_list',
                    first_day_ymd: year + '-' + month + '-01',
                }),
                async: false,
                dataType: 'json',
                success: function (res) {
                    let attendance_data = res.data.attendance
                    for (let i = 0; i < attendance_data.length; i++) {
                        let attendance = attendance_data[i];
                        let attendance_date = new Date(attendance.check_time);
                        let data = {
                            attendance_time: attendance_date,
                        };
                        attendance_list.push(data);
                    }
                    console.log(attendance_list);
                    
                },
                error: function (request, status, error) {
                    return [];
                }

            });
        }
        
        function attendance_check(today){
            //출석체크
            calendar_body = document.getElementById('calendar_body');
            attendance_id = calendar_body.getAttribute('data-attendance-id');  
            $.ajax({
                url: g5_url + 'attendance/ajax/'+ attendance_id +'/check',
                type: 'post',
                data: JSON.stringify({
                    'today': today,
                }),
                dataType: 'json',
                success: function (res) {
                    if (res.is_success) {
                        alert('출석 완료');
                    }
                    document.location.reload();
                },
                error: function (request, status, error) {
                    alert('출석 실패');
                }
            });
        }

        function calendar_render(attendance_list) {
            year = calendar_config.year;
            month = calendar_config.month;

            const calendar_body = document.getElementById('calendar_body');
            calendar_body.innerHTML = '';

            let first_day = new Date(year, month - 1, 1);
            let first_day_day = first_day.getDay();

            let last_day = new Date(year, month, 0);
            let last_day_date = last_day.getDate();
            let last_day_day = last_day.getDay();

            let count_item = 0;
            //이번달 첫째날의 요일을 구해서 공백 생성
            for (let i = 0; i < first_day_day; i++) {
                let div = document.createElement('div');
                div.classList.add('calendar_body_item');
                
                
                let inner_div_top = document.createElement('span');
                let inner_div_middle = document.createElement('span');
                let inner_div_bottom = document.createElement('span');

                inner_div_top.classList.add('attendance_check_row')
                inner_div_bottom.innerText = ''
                inner_div_middle.classList.add('calendar_date');
                inner_div_middle.innerText = '';

                inner_div_bottom.className = 'attendance_date_row';
                div.appendChild(inner_div_top);
                div.appendChild(inner_div_middle);
                div.appendChild(inner_div_bottom);
                
                calendar_body.appendChild(div);
                count_item++;
            }

            //이번달 날짜
            for (let i = 1; i <= last_day_date; i++) {
                let div = document.createElement('div');
                div.classList.add('calendar_body_item');
                let inner_div_top = document.createElement('span');
                let inner_div_middle = document.createElement('span');
                let inner_div_bottom = document.createElement('span');

                inner_div_top.classList.add('attendance_check_row')
                inner_div_bottom.innerText = ''
                inner_div_middle.classList.add('calendar_date');
                inner_div_middle.innerText = i;

                inner_div_bottom.className = 'attendance_date_row';
                div.appendChild(inner_div_top);
                div.appendChild(inner_div_middle);
                div.appendChild(inner_div_bottom);

                calendar_body.appendChild(div);
                count_item++;
            }

            //다음달 첫째날의 요일을 구해서 공백을 만들어준다.
            for (let i = 0; i < 6 - last_day_day; i++) {
                let div = document.createElement('div');
                //div.classList.add('calendar_body_none');
                div.classList.add('calendar_body_item');
                
                let inner_div_top = document.createElement('span');
                let inner_div_middle = document.createElement('span');
                let inner_div_bottom = document.createElement('span');

                inner_div_top.classList.add('attendance_check_row')
                inner_div_bottom.innerText = ''
                inner_div_middle.classList.add('calendar_date');
                inner_div_middle.innerText = '';

                inner_div_bottom.className = 'attendance_date_row';
                div.appendChild(inner_div_top);
                div.appendChild(inner_div_middle);
                div.appendChild(inner_div_bottom);
                
                calendar_body.appendChild(div);
                count_item++
            }

            const calendar_day_div = document.querySelectorAll('#calendar_body div');
            let is_even_row = false;
            for (let i = 0; i < calendar_day_div.length; i++) {
                if (i % 7 === 0) {
                    even_odd_row_switch();
                }
                
                let class_name = is_even_row ? 'calendar_odd_row' : 'calendar_even_row';
                calendar_day_div[i].classList.add(class_name);
            }

            function even_odd_row_switch() {
                is_even_row = !is_even_row;
            }

            const calendar_day_item = document.querySelectorAll('.calendar_body_item');
            let attendance_count = 0;
            let absent_count = 0;
            for (let i = 0; i < calendar_day_item.length; i++) {
                let calendar_body_item_date = calendar_day_item[i].querySelector('.calendar_date').innerText;
                let calendar_body_item_date_day = calendar_body_item_date;
                let comparing_target_time = Date.parse(year + '-' + month + '-' + calendar_body_item_date);

                if (calendar_config.current_time.getFullYear() == year && calendar_config.current_time.getMonth() + 1 == month
                    && calendar_config.date == calendar_body_item_date_day) {
                    calendar_day_item[i].querySelector('.attendance_date_row').innerHTML = '오늘&nbsp';
                }

                let attendance_time = check_attendance_day(attendance_list, year, month, calendar_body_item_date_day);
                let current_time = new Date();
                if (g5_is_member == '') {
                    continue;
                }
                if (attendance_time !== undefined) {
                    calendar_day_item[i].querySelector('.attendance_check_row').innerText = 'o';
                    calendar_day_item[i].querySelector('.attendance_date_row').innerText += attendance_time;
                    attendance_count++;
                } else if (comparing_target_time < current_time) {
                    calendar_day_item[i].querySelector('.attendance_check_row').innerText = 'x';
                    calendar_day_item[i].querySelector('.attendance_date_row').innerText += '';
                    absent_count++;
                }
            }

            let attendance_count_tag = document.querySelector('#attendance_count');
            attendance_count_tag.innerText = attendance_count;

            let absent_count_tag = document.querySelector('#absent_count');
            absent_count_tag.innerText = absent_count;

            /**
             * @param attendance_list array
             * @param year fullYear string
             * @param month string
             * @param date string
             * @return string
             */
            function check_attendance_day(attendance_list, year, month, date) {
                for (let j = 0; j < attendance_list.length; j++) {
                    let calendar_day = attendance_list[j].attendance_time;
                    if (year == calendar_day.getFullYear() && month == (calendar_day.getMonth() + 1) 
                    && date == calendar_day.getDate()) {
                        return calendar_day.getHours() + ':' + calendar_day.getMinutes()
                    }
                }
            }

        }
    </script>
{% endblock content%}