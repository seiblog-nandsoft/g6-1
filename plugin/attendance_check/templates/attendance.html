{% extends "base.html" %}

{% block head %}
     <style>
        .calendar_section {
            display: inline-block;
        }

        @media (max-width: 820px) {
            .calendar_section {
                display: block;
            }
        }

        @media (max-width: 1180px)  and   (orientation: landscape) {
            .calendar_section {
                display: block;
            }
        }

        #attendance_list {
            max-width: 705px;
            margin: 0 auto;
        }

        .calendar_header {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 1.8em;
        }

        .calendar_header_first_row {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        .calendar_header_button {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
        }

        #calendar_header_left_button, #calendar_header_right_button {
            padding: 5px 15px;
            margin: 1vh 0;
            /*background-color: #5B9BD5;*/
            /*background-color: #4d0585;*/
            background-color: #5B9BD5;
            color: #fff;
        }

        .attendance_statue {
            font-size: 1.5rem;
            text-align: center;
        }

        /* calendar_body_week */
        #calendar_body_week {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 1.6rem;
            font-size: 1.5rem;
        }

        #calendar_body_week div {
            width: 14%;
            text-align: center;
            background-color: #4c73c7;
            color: white;
        }

        #calendar_body {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-flow: wrap;
        }

        .calendar_body_item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: calc(100% / 7 - 2px);
            min-height: 5.7em;
            text-align: center;
            margin-bottom: 1px;

        }

        .calendar_date {
            height: 2rem;
            font-size: 2rem;
            margin-top: 5px;
            color: #111;
        }
        
        
        .attendance_date_row {
            height: 2rem;
            padding-top: 0.2rem;
            word-break: keep-all;
            margin-top: 5px;
            color: #111;
        }

        @media (max-width: 360px) {
            .attendance_date_row {
                font-size: 1.2rem;
                margin-top: 5px;
            }
        }

        .attendance_check_row {
            font-size: 2rem;
            height: 2rem;
            -webkit-text-stroke-width: 0.5px;
            -webkit-text-stroke-color: black;
            font-weight: bold;
            color: red;
        }

        #calendar_body div:nth-child(7n) > .calendar_date {
            color: blue;
        }

        #calendar_body div:nth-child(7n+1) > .calendar_date {
            color: red;
        }

        .calendar_even_row {
            background-color: #00b8f8;
        }

        .count_text {
            text-align: end;
            min-width: 14px;
            display: inline-block;
        }

        .icon_attendance, .icon_absent {
            color: red;
            margin-right: 12px;
            font-style: normal;
            display: inline-block;
            text-align: center;
            -webkit-text-stroke-width: 0.5px;
            -webkit-text-stroke-color: black;
            font-weight: bold;
        }

        .calendar_even_row {
            background-color: rgb(207, 213, 234);
        }

        .calendar_odd_row {
            background-color: rgb(233, 235, 245);
        }


    </style>
{% endblock %}

{% block title %}
    {{ title }}
{% endblock %}

{% block subtitle %}
{% endblock %}

{% block content %}

    <section class="calendar_section">
        <div></div>
        <div></div>
        <div id='attendance_list'>
            <div class='calendar_header'>
                <div class="calendar_header_first_row">
                    <div>
                        <span id='calendar_header_center_year'></span>년
                        <span id='calendar_header_center_month'></span>월
                    </div>
                    <div class="attendance_statue">
                        <div><i class="icon_attendance">O</i>출석 수:&nbsp
                            <span id='attendance_count' class="count_text"></span>일
                        </div>
                        <div><i class="icon_absent">X</i>결석 수:&nbsp<span id='absent_count' class="count_text"></span>일
                        </div>
                    </div>
                </div>

                <div class="calendar_header_button">
                    <div id='calendar_header_left'>
                        <button id='calendar_header_left_button'>이전달</button>
                    </div>
                    <div id='calendar_header_right'>
                        <button id='calendar_header_right_button'> 다음 달</button>
                    </div>

                </div>
            </div>
            <div>
                <div id='calendar_body_week'>
                    <div class='calendar_body_week_day'>일</div>
                    <div class='calendar_body_week_day'>월</div>
                    <div class='calendar_body_week_day'>화</div>
                    <div class='calendar_body_week_day'>수</div>
                    <div class='calendar_body_week_day'>목</div>
                    <div class='calendar_body_week_day'>금</div>
                    <div class='calendar_body_week_day'>토</div>
                </div>
                <div id='calendar_body'>
                </div>
            </div>
            
            
            

        </div>
    </section>


    <button type="button" class="cmt_btn">
        <span class="total"><b>댓글</b> {{ comments|count }}</span>
        <span class="cmt_more"></span>
    </button>
    <!-- 댓글 시작 { -->
    <section id="bo_vc">
        <h2>댓글목록</h2>
        {% for comment in comments %}
        {% set reply_depth=comment.wr_comment_reply|length %}
        <article id="c_{{ comment.wr_id }}" {% if reply_depth %}style="margin-left:{{ reply_depth * 50 }}px;border-top-color:#e0e0e0"{% endif %}>
            <div class="pf_img"><img src="/{{ get_member_image(comment.mb_id) }}" alt="profile_image"></div>
            <div class="cm_wrap">
                <header>
                    <h2>{{ comment.name }}님의  댓글</h2>
                        <span class="{% if comment.mb_id %}member{% else %}guest{% endif %}">
                            {{ comment.name }}
                        </span>
                    {% if comment.ip %}
                        <span class="sound_only">아이피</span>
                        <span>({{ comment.ip }})</span>
                    {% endif %}
                    <span class="sound_only">작성일</span>
                    <span class="bo_vc_hdinfo">
                        <i class="fa fa-clock-o" aria-hidden="true"></i>
                        <time datetime="{{ comment.wr_datetime|datetime_format }}">{{ comment.wr_datetime|datetime_format }}</time>
                    </span>
                </header>
        
                <div class="cmt_contents">
                    <p>
                        {% if comment.is_secret %}
                            <img src="{{ url_for('static', path="/img/icon_secret.gif") }}" alt="비밀 댓글">
                        {% endif %}
                        {% if comment.is_secret_content %}
                            <a href="{{ url_for('password_page', action="comment-view", bo_table=board.bo_table, wr_id=comment.wr_id) }}" class="s_cmt">
                                댓글내용 확인
                            </a>
                        {% else %}
                            {{ comment.wr_content|safe }}
                        {% endif %}
                    </p>
                </div>
                <span id="edit_{{ comment.wr_id }}" class="bo_vc_w"></span><!-- 수정 -->
                <span id="reply_{{ comment.wr_id }}" class="bo_vc_w"></span><!-- 답변 -->

                <input type="hidden" value="{% if "secret" in comment.wr_option %}secret{% endif %}" id="secret_comment_{{ comment.wr_id }}">
                <textarea id="save_comment_{{ comment.wr_id }}" style="display:none">{{ comment.save_content|safe }}</textarea>
            </div>
            <div class="bo_vl_opt">
                <button type="button" class="btn_cm_opt btn_b01 btn">
                    <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                    <span class="sound_only">댓글 옵션</span>
                </button>
                <ul class="bo_vc_act" style="display: none;">
                    {% if comment.is_reply %}
                    <li><a href="javascript:;" onclick="comment_box('{{ comment.wr_id }}', 'c'); return false;">답변</a></li>
                    {% endif %}
                    {% if comment.is_edit %}
                    <li><a href="javascript:;" onclick="comment_box('{{ comment.wr_id }}', 'cu'); return false;">수정</a></li>
                    {% endif %}
                    {% if comment.is_del %}
                    <li><a href="/board/delete_comment/{{ board.bo_table }}/{{ comment.wr_id }}" onclick="comment_delete(this.href); return false;">삭제</a></li>
                    {% endif %}
                </ul>
            </div>
            <script>
                $(function() {			    
                // 댓글 옵션창 열기
                $(".btn_cm_opt").on("click", function(){
                    $(this).parent("div").children(".bo_vc_act").show();
                });
                    
                // 댓글 옵션창 닫기
                $(document).mouseup(function (e){
                    var container = $(".bo_vc_act");
                    if( container.has(e.target).length === 0)
                    container.hide();
                });
            });
            </script>
        </article>
        {% else %}
        <p id="bo_vc_empty">등록된 댓글이 없습니다.</p>
        {% endfor %}
    </section>
    <!-- } 댓글 끝 -->

    {% if is_comment_write %}
        <!-- 댓글 쓰기 시작 { -->
        <aside id="bo_vc_w" class="bo_vc_w">
            <h2>댓글쓰기</h2>
            <form name="fviewcomment" id="fviewcomment" action="{{ url_for('write_comment_update') }}" onsubmit="return fviewcomment_submit(this);" method="post" autocomplete="off">
                <input type="hidden" name="w" id="w" value="c">
                <input type="hidden" name="bo_table" value="{{ board.bo_table }}">
                <input type="hidden" name="wr_id" value="{{ write.wr_id }}">
                <input type="hidden" name="comment_id" value="{{ request.query_params.c_id }}" id="comment_id">
                <input type="hidden" name="sca" value="{{ request.query_params.sca }}">
                <input type="hidden" name="sfl" value="{{ request.query_params.sfl }}">
                <input type="hidden" name="stx" value="{{ request.query_params.stx }}">
                <input type="hidden" name="spt" value="{{ request.query_params.spt }}">
                <input type="hidden" name="page" value="{{ request.query_params.page }}">
                <input type="hidden" name="token" value="">
                
                {% if board.bo_comment_min and board.bo_comment_max %}
                <script> check_byte('wr_content', 'char_count'); </script>
                <strong id="char_cnt"><span id="char_count">0</span>글자</strong>
                {% endif %}

                <span class="sound_only">내용</span>
                <textarea id="wr_content" name="wr_content" maxlength="10000" required="" class="required"
                    {% if board.bo_comment_min and board.bo_comment_max %}
                        onkeyup="check_byte('wr_content', 'char_count');"
                    {% endif %}
                    title="댓글 내용" placeholder="댓글내용을 입력해주세요"></textarea>

                <script>
                $(document).on("keyup change", "textarea#wr_content[maxlength]", function() {
                    var str = $(this).val()
                    var mx = parseInt($(this).attr("maxlength"))
                    if (str.length > mx) {
                        $(this).val(str.substr(0, mx));
                        return false;
                    }
                });
                </script>
                <div class="bo_vc_w_wr">
                    <div class="bo_vc_w_info">
                        {% if not request.state.login_member %}
                            <label for="wr_name" class="sound_only">이름<strong> 필수</strong></label>
                            <input type="text" name="wr_name" value="" id="wr_name" required class="frm_input required" size="25" placeholder="이름">
                            <label for="wr_password" class="sound_only">비밀번호<strong> 필수</strong></label>
                            <input type="password" name="wr_password" id="wr_password" required class="frm_input required" size="25"  placeholder="비밀번호">
                            <!-- Captcha Start -->
                            <fieldset id="captcha" class="captcha">{% include captcha_widget(request) ignore missing %}</fieldset>
                            <!-- Captcha End -->
                        {% endif %}
                        

                        <span class="bo_vc_secret chk_box">
                            <input type="checkbox" name="wr_secret" value="secret" id="wr_secret" class="selec_chk">
                            <label for="wr_secret" class="icon_lock">
                                <span>&nbsp;</span>비밀댓글
                            </label>
                        </span>
                    </div>
                    <div class="btn_confirm">
                        <button type="submit" id="btn_submit" class="btn_submit">댓글등록</button>
                    </div>
                </div>
            </form>
        </aside>
        <script>
            // 글자수 제한
            var char_min = 1 // 최소
            var char_max = parseInt({{ board.bo_comment_max }}); // 최대
        </script>
        <script>
        var save_before = '';
        var save_html = document.getElementById('bo_vc_w').innerHTML;
        /*
        function good_and_write()
        {
            var f = document.fviewcomment;
            if (fviewcomment_submit(f)) {
                f.is_good.value = 1;
                f.submit();
            } else {
                f.is_good.value = 0;
            }
        }
        */
        function fviewcomment_submit(f)
        {
            // 양쪽 공백 없애기
            var pattern = /(^\s*)|(\s*$)/g; // \s 공백 문자
            document.getElementById('wr_content').value = document.getElementById('wr_content').value.replace(pattern, "");
            if (char_min > 0 || char_max > 0)
            {
                check_byte('wr_content', 'char_count');
                var cnt = parseInt(document.getElementById('char_count').innerHTML);
                if (char_min > 0 && char_min > cnt) {
                    alert("댓글은 "+char_min+"글자 이상 쓰셔야 합니다.");
                    return false;
                } else if (char_max > 0 && char_max < cnt) {
                    alert("댓글은 "+char_max+"글자 이하로 쓰셔야 합니다.");
                    return false;
                }
            }
            else if (!document.getElementById('wr_content').value)
            {
                alert("댓글을 입력하여 주십시오.");
                return false;
            }

            if (typeof(f.wr_name) != 'undefined')
            {
                f.wr_name.value = f.wr_name.value.replace(pattern, "");
                if (f.wr_name.value == '')
                {
                    alert('이름이 입력되지 않았습니다.');
                    f.wr_name.focus();
                    return false;
                }
            }

            if (typeof(f.wr_password) != 'undefined')
            {
                f.wr_password.value = f.wr_password.value.replace(pattern, "");
                if (f.wr_password.value == '')
                {
                    alert('비밀번호가 입력되지 않았습니다.');
                    f.wr_password.focus();
                    return false;
                }
            }

            f.token.value = generate_token();
            if (f.token.value == "") {
                alert("토큰값이 없습니다.");
                return false;
            }

            // captcha 사용시
            if (typeof check_captcha === "function") {
                if (!check_captcha(f)) {
                    return false;
                }
            }

            // document.getElementById("btn_submit").disabled = "disabled";

            return true;
        }

        function comment_box(comment_id, work)
        {
            var el_id,
                form_el = 'fviewcomment',
                respond = document.getElementById(form_el);

            // 댓글 아이디가 넘어오면 답변, 수정
            if (comment_id) {
                if (work == 'c')
                    el_id = 'reply_' + comment_id;
                else
                    el_id = 'edit_' + comment_id;
            } else {
                el_id = 'bo_vc_w';
            }

            if (save_before != el_id)
            {
                if (save_before)
                {
                    document.getElementById(save_before).style.display = 'none';
                }

                document.getElementById(el_id).style.display = '';
                document.getElementById(el_id).appendChild(respond);
                //입력값 초기화
                document.getElementById('wr_content').value = '';
                
                // 댓글 수정
                if (work == 'cu')
                {
                    document.getElementById('wr_content').value = document.getElementById('save_comment_' + comment_id).value;
                    if (typeof char_count != 'undefined')
                        check_byte('wr_content', 'char_count');
                    if (document.getElementById('secret_comment_'+comment_id).value)
                        document.getElementById('wr_secret').checked = true;
                    else
                        document.getElementById('wr_secret').checked = false;
                }

                document.getElementById('comment_id').value = comment_id;
                document.getElementById('w').value = work;

                if(save_before)
                    $("#captcha_reload").trigger("click");

                save_before = el_id;
            }
        }

        function comment_delete(href) {
            if (confirm("이 댓글을 삭제하시겠습니까?")) {
                token = generate_token();
                location.href = href + "?token=" + token
                return true;
            }
            return false;
        }

        comment_box('', 'c'); // 댓글 입력폼이 보이도록 처리하기위해서 추가 (root님)

        </script>
        <!-- } 댓글 쓰기 끝 -->
    {% endif %}
    <script>

        const today = new Date();
        let year = today.getFullYear();
        let month = today.getMonth() + 1;
        let today_date = today.getDate();
        let today_day = today.getDay();

        const calendar_config = {
            year: year,
            month: month,
            date: today_date,
            current_time: today,
            attendance_count: 0,
            absent_count: 0
        }

        /**
         * 출결 데이터 전역변수
         * @type {*[]}
         */
        let attendance_list = [];
        init();

        function init() {
            get_attendance_list(year, month);
            calendar_render(attendance_list);
            set_calendar_header();

            const next_month = document.querySelector('#calendar_header_right_button');
            const prev_month = document.querySelector('#calendar_header_left_button');

            next_month.addEventListener('click', show_next_month);
            prev_month.addEventListener('click', show_prev_month);
        }

        /**
         * +1 -1 (이전, 이후 달 만설정)
         * @param modify_number
         * @returns {null}
         */
        function set_month(modify_number) {
            if (modify_number > 1 || modify_number < -1) {
                return;
            }

            const month = calendar_config.month
            calendar_config.month += modify_number;
            if (month + modify_number > 12) {
                calendar_config.year++;
                calendar_config.month = (month + modify_number) % 12
            }

            if (month + modify_number < 1) {
                calendar_config.year--;
                calendar_config.month = 12;
            }
        }

        function show_next_month() {
            set_month(1);
            set_calendar_header();
            calendar_render(attendance_list);
        }

        function show_prev_month() {
            set_month(-1);
            set_calendar_header();
            calendar_render(attendance_list);
        }

        function set_calendar_header() {
            const calendar_header_center_year = document.getElementById('calendar_header_center_year');
            const calendar_header_center_month = document.getElementById('calendar_header_center_month');
            calendar_header_center_year.innerText = calendar_config.year;
            calendar_header_center_month.innerText = calendar_config.month;
        }

        function get_attendance_list(year, month) {
            $.ajax({
                url: g5_url + '/main/community/attendance_check.php',
                type: 'post',
                data: JSON.stringify({
                    mode: 'get_attendance_list',
                    first_day_ymd: year + '-' + month + '-01',
                }),
                async: false,
                dataType: 'json',
                success: function (res) {
                    if (res.is_success) {
                        let attendance_data = res.attendance_list;
                        for (let i = 0; i < attendance_data.length; i++) {
                            let attendance = attendance_data[i];
                            let attendance_date = new Date(attendance.attendance_time);
                            let data = {
                                attendance_time: attendance_date,
                            };
                            attendance_list.push(data)
                        }
                    }
                },
                error: function (request, status, error) {
                    return [];
                }

            });
        }

        function calendar_render(attendance_list) {
            year = calendar_config.year;
            month = calendar_config.month;

            const calendar_body = document.getElementById('calendar_body');
            calendar_body.innerHTML = '';

            let first_day = new Date(year, month - 1, 1);
            let first_day_day = first_day.getDay();

            let last_day = new Date(year, month, 0);
            let last_day_date = last_day.getDate();
            let last_day_day = last_day.getDay();

            let count_item = 0;
            //이번달 첫째날의 요일을 구해서 공백 생성
            for (let i = 0; i < first_day_day; i++) {
                let div = document.createElement('div');
                div.classList.add('calendar_body_item');
                
                
                let inner_div_top = document.createElement('span');
                let inner_div_middle = document.createElement('span');
                let inner_div_bottom = document.createElement('span');

                inner_div_top.classList.add('attendance_check_row')
                inner_div_bottom.innerText = ''
                inner_div_middle.classList.add('calendar_date');
                inner_div_middle.innerText = '';

                inner_div_bottom.className = 'attendance_date_row';
                div.appendChild(inner_div_top);
                div.appendChild(inner_div_middle);
                div.appendChild(inner_div_bottom);
                
                calendar_body.appendChild(div);
                count_item++;
            }

            //이번달 날짜
            for (let i = 1; i <= last_day_date; i++) {
                let div = document.createElement('div');
                div.classList.add('calendar_body_item');
                let inner_div_top = document.createElement('span');
                let inner_div_middle = document.createElement('span');
                let inner_div_bottom = document.createElement('span');

                inner_div_top.classList.add('attendance_check_row')
                inner_div_bottom.innerText = ''
                inner_div_middle.classList.add('calendar_date');
                inner_div_middle.innerText = i;

                inner_div_bottom.className = 'attendance_date_row';
                div.appendChild(inner_div_top);
                div.appendChild(inner_div_middle);
                div.appendChild(inner_div_bottom);

                calendar_body.appendChild(div);
                count_item++;
            }

            //다음달 첫째날의 요일을 구해서 공백을 만들어준다.
            for (let i = 0; i < 6 - last_day_day; i++) {
                let div = document.createElement('div');
                //div.classList.add('calendar_body_none');
                div.classList.add('calendar_body_item');
                
                let inner_div_top = document.createElement('span');
                let inner_div_middle = document.createElement('span');
                let inner_div_bottom = document.createElement('span');

                inner_div_top.classList.add('attendance_check_row')
                inner_div_bottom.innerText = ''
                inner_div_middle.classList.add('calendar_date');
                inner_div_middle.innerText = '';

                inner_div_bottom.className = 'attendance_date_row';
                div.appendChild(inner_div_top);
                div.appendChild(inner_div_middle);
                div.appendChild(inner_div_bottom);
                
                
                calendar_body.appendChild(div);
                count_item++
            }

            const calendar_day_div = document.querySelectorAll('#calendar_body div');
            let is_even_row = false;
            for (let i = 0; i < calendar_day_div.length; i++) {
                if (i % 7 === 0) {
                    even_odd_row_switch();
                }
                
                let class_name = is_even_row ? 'calendar_odd_row' : 'calendar_even_row';
                calendar_day_div[i].classList.add(class_name);
            }

            function even_odd_row_switch() {
                is_even_row = !is_even_row;
            }

            const calendar_day_item = document.querySelectorAll('.calendar_body_item');
            let attendance_count = 0;
            let absent_count = 0;
            for (let i = 0; i < calendar_day_item.length; i++) {
                let calendar_body_item_date = calendar_day_item[i].querySelector('.calendar_date').innerText;
                let calendar_body_item_date_day = calendar_body_item_date;
                let comparing_target_time = Date.parse(year + '-' + month + '-' + calendar_body_item_date);

                if (calendar_config.current_time.getFullYear() == year && calendar_config.current_time.getMonth() + 1 == month
                    && calendar_config.date == calendar_body_item_date_day) {
                    calendar_day_item[i].querySelector('.attendance_date_row').innerHTML = '오늘&nbsp';
                }

                let attendance_time = check_attendance_day(attendance_list, year, month, calendar_body_item_date_day);
                let current_time = new Date();
                if (g5_is_member == '') {
                    continue;
                }
                if (attendance_time !== undefined) {
                    calendar_day_item[i].querySelector('.attendance_check_row').innerText = 'o';
                    calendar_day_item[i].querySelector('.attendance_date_row').innerText += attendance_time;
                    attendance_count++;
                } else if (comparing_target_time < current_time) {
                    calendar_day_item[i].querySelector('.attendance_check_row').innerText = 'x';
                    calendar_day_item[i].querySelector('.attendance_date_row').innerText += '결석';
                    absent_count++;
                }
            }

            let attendance_count_tag = document.querySelector('#attendance_count');
            attendance_count_tag.innerText = attendance_count;

            let absent_count_tag = document.querySelector('#absent_count');
            absent_count_tag.innerText = absent_count;

            /**
             *
             * @param attendance_list array
             * @param year fullYear string
             * @param month string
             * @param date string
             * @return string
             */
            function check_attendance_day(attendance_list, year, month, date) {
                for (let j = 0; j < attendance_list.length; j++) {
                    let calendar_day = attendance_list[j].attendance_time;
                    if (year == calendar_day.getFullYear() && month == (calendar_day.getMonth() + 1) && date == calendar_day.getDate()) {
                        return calendar_day.getHours() + ':' + calendar_day.getMinutes()
                    }
                }
            }

        }
    </script>
{% endblock %}